# Auto Set Owner

Coming soon...

Every `DragonTreasure` must have an `Owner` and to set that we currently require when you're posting to create a treasure that you set the specific owner. Now we've added some validation to make sure that you only set yourself as the owner, but we still need to pass this field. I think we should make that optional. So delete that. The idea is that we'll automatically set if the `owner` property is not sent, we'll automatically set it to the currently authenticated user. Now right now this should make that test fail. So I'm going to copy that test name, run it, and perfect. Yeah, 422. It got a 422, but 201 expected. Oh, and it's a 422. If you look at this, it is because we have validation on the `owner` property. This value should not be null. So if we're going to make it optional, we're going to need to first take off that `assert\notNull` on there. And now when we try the test, we are greeted with a beautiful 500 error, probably because it's exploding in the database. Yep, not null violation error. Owner ID must owner ID. All right, so how can we automatically set this field if it's not already set? Well in the previous API Platform 2 tutorial, I did this with an entity listener, which is a fine solution. But in API Platform 3, just like when we hashed the user password, there's now a really nice system for this. We can leverage the state processor system. As a reminder, our post and patch endpoints for `DragonTreasure` already have a state processor that comes from Doctrine, which is responsible for actually saving it to the database. What we're going to do is decorate that and do something in addition to that. So just like before, to start this out, we're going to run `bin console make state processor`. And I'm going to call it `DragonTreasureSetOwnerProcessor`. Perfect. And in the `src/State` directory, here we go. Just like we've done multiple times now, we're going to set up decoration. So we're going to add a construct method. All right. And inside we'll say `private ProcessorInterface` and I'll call it `innerProcessor`. Perfect. And then down here in `process` we just call that. So this method doesn't return anything, it's got a void return type, so we just say this error process data operation URI variables and context. All right. Now to actually make a make symphony use our data process state processor instead of the normal one from doctrine, we say as decorator. And then the name of the service is a pet platform doctrine dot or m dot state dot persist processor. So now when everything that uses this service in the system will now be passed to our service, then the original service will be passed into us. Now one kind of cool thing about this is that if you look at our user hash password processor, we're decorating the same service there. So we're actually decorating that service two times, which in symphony is totally allowed. All right, so let's get to work actually setting the owner. So we're going to auto wire. Actually, let me say private security security. And then down here before we do the saving. Say if data is an instance of DragonTreasure and data arrow get owner is null and this arrow security arrow get user, we actually have a user logged in. We should, but just checking that to be sure. Then we'll say data arrow set owner this arrow security arrow get user and that should do it. All right, run that test. And ooh, allowed memory size exhausted. That smells to me like I got some recursion. And I know what it is because I do this all the time. This arrow inner processor arrow process, don't forget that part. Now when I try it, passing test is much better than recursion. And the owner field is now optional. All right, next, we currently return unpublished treasures from our get collection get collection treasures endpoint. Let's finally fix that by automatically modifying the query behind this endpoint to hide those. Thanks.
